VERTX_VERSION=vert.x-2.0.2-final
VERTX_URL=http://dl.bintray.com/vertx/downloads/$VERTX_VERSION.tar.gz
VERTX_USER=vertx

CREATE_USER=false

chmod +x /etc/init.d/vertx
chmod +x /etc/init.d/vertx-deploy

# Download and unpack vert.x
wget -P /tmp $VERTX_URL
tar -C /opt -xzvf /tmp/$VERTX_VERSION.tar.gz
ln -s /opt/$VERTX_VERSION /opt/vert.x

# Add User
getent passwd $VERTX_USER >/dev/null 2>&1 && CREATE_USER=true

if $CREATE_USER; then
    echo "$VERTX_USER already exists."
else
  groupadd  -f vertx
  useradd -g $VERTX_USER -d /opt/vert.x -s /bin/false $VERTX_USER
fi

# Create LOG dir
if [ ! -d /var/log/vertx ]
then
    mkdir /var/log/vertx
fi

# Create default dirs
mkdir /opt/vert.x/repo
mkdir /opt/vert.x/sys-mods
mkdir /opt/vert.x/mods

if [ ! -d /var/www ]
then
   mkdir /var/www
fi

# Copy extra libs
cp $bundledjardir/*.jar /opt/vert.x/lib

unzip -d /opt/vert.x/sys-mods/nl.jpoint.vertx-deploy-tools~vertx-deploy-mod~${project.version} /$datadir/vertx-deploy-mod-${project.version}.zip
# cp /$datadir/logback.xml /opt/vert.x/conf/
# cp /$datadir/repos.txt /opt/vert.x/conf/
rm /opt/vert.x/conf/repos.txt

ln -sf /etc/vertx/logback.xml /opt/vert.x/conf/logback.xml
ln -sf /etc/vertx/repos.txt /opt/vert.x/conf/repos.txt

# Set user rights
chown -R $VERTX_USER:$VERTX_USER /opt/vert.x/
chown -R $VERTX_USER:$VERTX_USER /var/log/vertx
chown -R $VERTX_USER:$VERTX_USER /etc/vertx

chown -R $VERTX_USER:$VERTX_USER /var/www

chmod 0440 /etc/sudoers.d/vertx

/etc/init.d/vertx-deploy start

update-rc.d vertx-deploy defaults
update-rc.d vertx defaults
